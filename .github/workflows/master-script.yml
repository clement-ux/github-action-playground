name: Counter Script increment()

on:
  # Trigger via AWS EventBridge (Webhook)
  repository_dispatch:
    types: [run-foundry-script]
  
  # Manual trigger (GitHub Button) for easy testing
  workflow_dispatch:
    inputs:
      number_value:
        description: 'Numeric value to use in the script'
        required: true
        default: '10'

jobs:
  execute:
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: "stable"

      - name: Install Dependencies
        run: forge install
      
      - name: Run Dynamic Script via AWS KMS
        run: |
          echo "ðŸš€ Launching script: CounterInteraction"
          
          # 1. Input handling (Compatible with GitHub Button OR AWS Webhook)
          # If inputs.number_value is empty (webhook case), we look into client_payload
          VALEUR="${{ inputs.number_value || github.event.client_payload.number_value }}"
          echo "ðŸ”¢ Value to send: $VALEUR"

          # 2. Dynamic retrieval of KMS address
          # We use your AWS credentials to find the associated Ethereum public address
          SENDER_ADDR=$(cast wallet address --aws)
          echo "ðŸ”‘ Signing with AWS KMS Address: $SENDER_ADDR"
          
          # 3. Script execution
          forge script script/CounterInteraction.s.sol \
            --rpc-url ${{ secrets.RPC_URL }} \
            --aws \
            --sender $SENDER_ADDR \
            --broadcast \
            -vvvvv

          # 4. Displaying the Hash
          find broadcast -name "run-latest.json" -exec grep -o '"transactionHash": "[^"]*"' {} \;

        env:
            # For the Solidity script
            NUMBER_VALUE: ${{ inputs.number_value || github.event.client_payload.number_value }}
            
            # For infra (GitHub Secrets)
            RPC_URL: ${{ secrets.RPC_URL }}
            
            # For AWS authentication (Required for --aws)
            AWS_REGION: ${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_KMS_KEY_ID: ${{ secrets.KMS_KEY_ID }}