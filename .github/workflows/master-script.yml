name: Scheduled Counter Script

on:
  # 1. AUTOMATIC TRIGGER (CRON)
  #schedule:
    # Syntax: 'minute hour day month day-of-week'
    # '*/5 * * * *' = Every 5 minutes
    # '0 8 * * *'    = Every day at 08:00 UTC
    #- cron: '*/5 * * * *' 
  
  # 2. MANUAL TRIGGER (Button)
  workflow_dispatch:
    inputs:
      number_value:
        description: 'Value to increment'
        required: false
        default: '1'

jobs:
  execute:
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: "stable"

      - name: Install Dependencies
        run: forge install
      
      - name: Run Script (Auto or Manual)
        run: |
          echo "ðŸš€ Launching script: CounterInteraction"
          
          # LOGIC:
          # If triggered manually (inputs exists) -> Use input
          # If triggered by Cron (inputs empty)   -> Use default value '1'
          VALEUR="${{ inputs.number_value || '1' }}"
          echo "ðŸ”¢ Value to send: $VALEUR"

          # Get KMS Address
          SENDER_ADDR=$(cast wallet address --aws)
          echo "ðŸ”‘ Signing with AWS KMS Address: $SENDER_ADDR"
          
          # Run Forge
          forge script script/CounterInteraction.s.sol \
            --rpc-url ${{ secrets.RPC_URL }} \
            --aws \
            --sender $SENDER_ADDR \
            --broadcast \
            -vvvvv

          # Find and display hash
          find broadcast -name "run-latest.json" -exec grep -o '"transactionHash": "[^"]*"' {} \;

        env:
            # Passes the calculated value (Manual or Default) to Solidity
            NUMBER_VALUE: ${{ inputs.number_value || '1' }}
            
            # Secrets
            RPC_URL: ${{ secrets.RPC_URL }}
            AWS_REGION: ${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_KMS_KEY_ID: ${{ secrets.AWS_KMS_KEY_ID }}